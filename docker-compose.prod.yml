version: '3'

services:
  mysql:
    container_name: "server-mysql"
    volumes:
      - mysql_data:/var/lib/mysql
    image: mysql:8
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: "password"
      MYSQL_DATABASE: "test_db"
    ports:
      - "3306:3306"
  server1:
    # container_name: "server-app"
    image: "server-app1"
    build:
      context: .
      dockerfile: Dockerfile
    command: bash -c 'while !</dev/tcp/mysql/3306; do echo "waiting for mysql to be ready...."; sleep 5; done; npm run start'
    ports:
      - "3001:3000"
    env_file:
      - .env
    depends_on:
      - mysql
  server2:
    # container_name: "server-app"
    image: "server-app2"
    build:
      context: .
      dockerfile: Dockerfile.dev
    command: bash -c 'while !</dev/tcp/mysql/3306; do echo "waiting for mysql to be ready...."; sleep 5; done; npm run start:dev'
    ports:
      - "3002:3000"
    env_file:
      - .env
    depends_on:
      - mysql
  load-balancer:
    image: haproxy:2.4
    ports:
      - "3000:3000"
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg
    depends_on:
      - server1
      - server2
volumes:
  mysql_data: